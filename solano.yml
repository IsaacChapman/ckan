# Solano CI configuration file
# www.solanolabs.com

# Language/tools versions
java:
  java_version: 'java-8-oracle'
postgres:
  version: '9.4'
phantomjs:
  version: '0.10.31'
nodejs:
  version: '1.9.1'
solr:
  version: '6.0.0'
  path: 'solr/ckan'
redis:
  version: '3.0.2'
  

# Environment
environment:
  'PIP_USE_MIRRORS': 'true'

# Setup hooks
hooks:
  pre_setup: |
    set -o errexit -o pipefail # Exit on error
    # Install dependencies
    pip install -r requirements.txt
    pip install -r dev-requirements.txt
    python setup.py develop
    npm install mocha-phantomjs@3.5.0
    # Use Solano CI provided environment variables
    sed -i -e "s#.*datastore.write_url.*#ckan.datastore.write_url = postgresql://$TDDIUM_DB_USER:$TDDIUM_DB_PASSWORD@/$TDDIUM_DB_NAME#" test-core.ini
    sed -i -e "s#.*datastore.read_url.*#ckan.datastore.read_url = postgresql://$TDDIUM_DB_USER:$TDDIUM_DB_PASSWORD@/$TDDIUM_DB_NAME#" test-core.ini
    sed -i -e "s#solr_url.*#solr_url = http://${TDDIUM_SOLR_HOST}:${TDDIUM_SOLR_PORT}/${TDDIUM_SOLR_PATH}#" test-core.ini    
    sed -i -e "s#.*redis.url.*#ckan.redis.url = $REDIS_URL#" test-core.ini 
  worker_setup: paster db init -c test-core.ini

tests:
  - nosetests # parallelize later
  - mocha-phantomjs http://localhost:5000/base/test/index.html

worker_limit: 1 # For now


